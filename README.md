# borg-k8s-volume-backup
Backing up kubernetes volumes on a node using borg backup

This repo will soon contain a docker image and kubernetes resource YAMLs for backing up kubernetes volumes in a cluster

### Basic concept
- Kubelet mounts pod volumes as `/var/lib/kubelet/pods/<pod_uuid>/volumes/<volume_type>/<volume_name>`
  - NOTE! `volume_name` here refers to the "VOLUME" attribute listed in `kubectl get pvc` output, NOT the "NAME" attribute
- By iterating over `/var/lib/kubelet/pods/*/volumes/*/*`, we can run operations on each mounted volume on a k8s node
  - For example, by iterating over `/var/lib/kubelet/pods/*/volumes/kubernetes.io~iscsi/*`, we can back up each mounted iSCSI volume.

### Short-term Goals
- use `kubectl get pvc` to get all PVCs, and build a volume name to PVC name dictionary
- Use this dictionary to save backups using the PVC name rather than the volume name
  - The PVC name is typically specified by the user in a PVC resource YAML
  - The volume name may be automatically generated by a dynamic volume provisioner

### End goals
- Create a docker container that can do this backup operation
  - Pull in kubernetes volume type as env variable
  - Pull in borg repository location as env variable
  - Pull in borg passphrase as env variable
  - Run as root in container
  - Mount `/var/lib/kubelet/pods/` using `hostPath`
  - Run a backup script in container to back up all mounted PVCs on the kubernetes node
- Create a `DaemonSet`, so that one can easily back up all PVCs in a cluster by running the container on each node
  - Maybe even a `DaemonJob`, if that gets merged.
